@page "/Workflow/Builder/{WorkflowId:int?}"
@using EBSCore.Web.Models.Workflow
@using Microsoft.AspNetCore.Components
@using Microsoft.JSInterop
@using System.Net.Http.Json
@inject IJSRuntime JS
@inject HttpClient Http

<h3>Workflow Builder</h3>
<div id="drawflow" style="width:100%;height:400px;border:1px solid #ccc;"></div>
<button class="btn btn-primary" @onclick="Save">Save</button>
@if (!string.IsNullOrWhiteSpace(errorMessage))
{
    <div class="alert alert-danger mt-2">@errorMessage</div>
}

@code {
    [Parameter]
    public int? WorkflowId { get; set; }

    private WorkflowDefinition definition = new WorkflowDefinition();
    private string? errorMessage;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("initDrawflow");
            if (WorkflowId.HasValue)
            {
                await LoadDefinitionAsync();
            }
        }
    }

    private async Task LoadDefinitionAsync()
    {
        errorMessage = null;
        try
        {
            var response = await Http.GetFromJsonAsync<WorkflowDefinition>($"api/Workflow/GetById/{WorkflowId}");
            if (response != null)
            {
                definition = response;
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        StateHasChanged();
    }

    private async Task Save()
    {
        errorMessage = null;
        try
        {
            await JS.InvokeVoidAsync("saveDrawflow");
            var response = await Http.PostAsJsonAsync("api/S7SWorkflow/Save", definition);
            if (!response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                errorMessage = string.IsNullOrWhiteSpace(content) ? "Unable to save workflow." : content;
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
    }
}

<script src="https://cdn.jsdelivr.net/npm/drawflow@0.0.46/dist/drawflow.min.js"></script>
<script>
    window.initDrawflow = function () {
        const container = document.getElementById('drawflow');
        const editor = new Drawflow(container);
        editor.start();
        container.drawflowEditor = editor;
    };
    window.saveDrawflow = function () {
        const container = document.getElementById('drawflow');
        const editor = container.drawflowEditor;
        if (editor) {
            console.log(JSON.stringify(editor.export()));
        }
    };
</script>
