@using Microsoft.Extensions.Localization
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@using Newtonsoft.Json
@inject NavigationManager Navigation
@inject IStringLocalizerFactory LocalizerFactory
@page "/Workflow/Builder/{WorkflowId:int?}"
@using EBSCore.Web.Models.Workflow
@using Microsoft.AspNetCore.Components
@using Microsoft.JSInterop
@using System
@using System.Text.Json
@using System.Net.Http.Json
@inject IJSRuntime JS
@inject HttpClient Http

<div class="workflow-header d-flex justify-content-between align-items-center mb-3">
    <h3>Workflow Builder</h3>

    <div class="d-flex gap-2">
        <button class="btn btn-secondary" @onclick="LoadWorkflowAsync">
            <i class="fas fa-sync"></i> Reload
        </button>

        <button class="btn btn-primary" @onclick="SaveWorkflowAsync">
            <i class="fas fa-save"></i> Save
        </button>
    </div>
</div>

<div class="workflow-container d-flex gap-3">

    <!-- PALETTE -->
    <div class="workflow-palette p-2">
        <h5 class="fw-bold">Palette</h5>

        <div class="palette-item" draggable="true" ondragstart="event.dataTransfer.setData('node','start');">
            ðŸŸ¢ Start
        </div>

        <div class="palette-item" draggable="true" ondragstart="event.dataTransfer.setData('node','task');">
            ðŸ”µ Task
        </div>

        <div class="palette-item" draggable="true" ondragstart="event.dataTransfer.setData('node','decision');">
            ðŸŸ¡ Decision
        </div>

        <div class="palette-item" draggable="true" ondragstart="event.dataTransfer.setData('node','end');">
            ðŸ”´ End
        </div>
    </div>

<!-- DRAWFLOW CANVAS -->
<div id="drawflow" class="drawflow-wrapper flex-grow-1">
    <div id="drawflow_canvas" class="drawflow drawflow-canvas"></div>
</div>



</div>

@if (!string.IsNullOrWhiteSpace(errorMessage))
{
    <div class="alert alert-danger mt-3">@errorMessage</div>
}

@code {

    [Parameter] public int? WorkflowId { get; set; }

    private WorkflowDefinition definition = new();
    private string? errorMessage = null;

    // ---------------------------------------------------------
    // INITIALIZATION
    // ---------------------------------------------------------
    private bool _builderInitialized;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_builderInitialized)
            return;

        try
        {
            await JS.InvokeVoidAsync("WorkflowBuilder.init");
            _builderInitialized = true;

            if (WorkflowId.HasValue)
                await LoadWorkflowAsync();
        }
        catch (JSException ex) when (ex.Message.Contains("prerender", StringComparison.OrdinalIgnoreCase))
        {
            // Ignore prerender phase; Blazor will re-render when the circuit is connected.
        }
        catch (InvalidOperationException ex) when (ex.Message.Contains("prerender", StringComparison.OrdinalIgnoreCase))
        {
            // Ignore prerender phase; Blazor will re-render when the circuit is connected.
        }
    }

    // ---------------------------------------------------------
    // LOAD
    // ---------------------------------------------------------
    private async Task LoadWorkflowAsync()
    {
        try
        {
            errorMessage = null;

            var json = await Http.GetStringAsync($"api/S7SWorkflow/GetOne?workflowID={WorkflowId}");
            var list = JsonSerializer.Deserialize<List<WorkflowDefinition>>(json);

            if (list != null && list.Any())
                definition = list.First();
            else
                definition = new WorkflowDefinition();

            // Load model into Drawflow
            await JS.InvokeVoidAsync("WorkflowBuilder.load", definition.NodesJson ?? "{}", definition.ConnectionsJson ?? "[]");
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
    }

    // ---------------------------------------------------------
    // SAVE
    // ---------------------------------------------------------
    private async Task SaveWorkflowAsync()
    {
        try
        {
            errorMessage = null;

            // Extract JSON from drawflow
            var exported = await JS.InvokeAsync<string>("WorkflowBuilder.export");

            var wf = JsonSerializer.Deserialize<DrawflowExportModel>(exported);

            if (wf == null)
            {
                errorMessage = "Unable to parse workflow diagram.";
                return;
            }

            // Convert to workflow definition
            definition.NodesJson = JsonSerializer.Serialize(wf.nodes);
            definition.ConnectionsJson = JsonSerializer.Serialize(wf.connections);

            // Save
            var response = await Http.PostAsJsonAsync("api/S7SWorkflow/Save", definition);

            if (!response.IsSuccessStatusCode)
            {
                errorMessage = await response.Content.ReadAsStringAsync();
                if (string.IsNullOrWhiteSpace(errorMessage))
                    errorMessage = "Error saving workflow.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
    }

    // Drawflow â†’ C# mapping model
    public class DrawflowExportModel
    {
        public Dictionary<string, object>? nodes { get; set; }
        public List<object>? connections { get; set; }
    }
}
