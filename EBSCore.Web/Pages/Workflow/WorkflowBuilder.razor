@page "/Workflow/Builder/{WorkflowId:int?}"
@using EBSCore.Web.Models.Workflow
@using Microsoft.AspNetCore.Components
@using Microsoft.JSInterop
@inject IJSRuntime JS
@inject HttpClient Http

<h3>Workflow Builder</h3>
<div id="drawflow" style="width:100%;height:400px;border:1px solid #ccc;"></div>
<button class="btn btn-primary" @onclick="Save">Save</button>

@code {
    [Parameter]
    public int? WorkflowId { get; set; }

    private WorkflowDefinition definition = new WorkflowDefinition();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("initDrawflow");
        }
    }

    private async Task Save()
    {
        await JS.InvokeVoidAsync("saveDrawflow");
        await Http.PostAsJsonAsync("api/S7SWorkflow/Save", definition);
    }
}

<script src="https://cdn.jsdelivr.net/npm/drawflow@0.0.46/dist/drawflow.min.js"></script>
<script>
    window.initDrawflow = function () {
        const container = document.getElementById('drawflow');
        const editor = new Drawflow(container);
        editor.start();
        container.drawflowEditor = editor;
    };
    window.saveDrawflow = function () {
        const container = document.getElementById('drawflow');
        const editor = container.drawflowEditor;
        if (editor) {
            console.log(JSON.stringify(editor.export()));
        }
    };
</script>
