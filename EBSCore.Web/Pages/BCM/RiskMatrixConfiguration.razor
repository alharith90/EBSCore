@page "/BCM/RiskMatrixConfiguration"
@using EBSCore.Web.Models.BCM
@using EBSCore.Web.Services
@using Microsoft.Extensions.Localization
@using Microsoft.JSInterop
@using Newtonsoft.Json
@using System.Data
@using Microsoft.AspNetCore.Components.Forms
@inject HttpClient Http
@inject IStringLocalizerFactory LocalizerFactory
@inject IJSRuntime JS
@inject PageTitleService PageTitleService

@{
    var Localizer = LocalizerFactory.Create("BCM/Risk", "");
    var GLocalizer = LocalizerFactory.Create("Common", "");
}

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">@Localizer["RiskMatrixConfiguration"]</h5>
        <button class="btn btn-outline-dark" @onclick="LoadAsync"><i class="fas fa-rotate"></i> @GLocalizer["Refresh"]</button>
    </div>
    <div class="card-body">
        <EditForm Model="Matrix" OnValidSubmit="SaveMatrixAsync">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">@Localizer["MatrixName"]</label>
                    <InputText class="form-control" @bind-Value="Matrix.MatrixName" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">@Localizer["MatrixSize"]</label>
                    <InputNumber class="form-control" @bind-Value="Matrix.MatrixSize" />
                </div>
                <div class="col-md-4 d-flex align-items-center">
                    <div class="form-check mt-4">
                        <InputCheckbox class="form-check-input" @bind-Value="Matrix.IsDynamic" />
                        <label class="form-check-label">@Localizer["IsDynamic"]</label>
                    </div>
                </div>
                <div class="col-md-12">
                    <label class="form-label">@Localizer["ConfigJson"]</label>
                    <InputTextArea class="form-control" @bind-Value="Matrix.ConfigJson" Rows="3" />
                </div>
            </div>
            <div class="mt-3 d-flex justify-content-end">
                <button class="btn btn-success" type="submit"><i class="fas fa-save"></i> @GLocalizer["Save"]</button>
            </div>
        </EditForm>

        <hr />

        <EditForm Model="Tolerance" OnValidSubmit="SaveToleranceAsync">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">@Localizer["HighThreshold"]</label>
                    <InputNumber class="form-control" @bind-Value="Tolerance.HighThreshold" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">@Localizer["MediumThreshold"]</label>
                    <InputNumber class="form-control" @bind-Value="Tolerance.MediumThreshold" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">@Localizer["LowLabel"]</label>
                    <InputText class="form-control" @bind-Value="Tolerance.LowLabel" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">@Localizer["MediumLabel"]</label>
                    <InputText class="form-control" @bind-Value="Tolerance.MediumLabel" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">@Localizer["HighLabel"]</label>
                    <InputText class="form-control" @bind-Value="Tolerance.HighLabel" />
                </div>
            </div>
            <div class="mt-3 d-flex justify-content-end">
                <button class="btn btn-primary" type="submit"><i class="fas fa-flag"></i> @Localizer["SaveTolerance"]</button>
            </div>
        </EditForm>

        <div class="mt-4">
            <h6>@Localizer["Preview"]</h6>
            <div id="risk-matrix-preview" style="height:320px"></div>
        </div>
    </div>
</div>

@code {
    private S7SRiskMatrixConfiguration Matrix { get; set; } = new();
    private S7SRiskLevel Tolerance { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        PageTitleService.SetTitle(LocalizerFactory.Create("BCM/Risk", "")["RiskMatrixConfiguration"]);
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        await LoadMatrixAsync();
        await LoadToleranceAsync();
        await LoadPreviewAsync();
    }

    private async Task LoadMatrixAsync()
    {
        try
        {
            var json = await Http.GetStringAsync("/api/S7SRisk/MatrixConfig");
            var table = JsonConvert.DeserializeObject<DataTable>(json);
            if (table != null && table.Rows.Count > 0)
            {
                var row = table.Rows[0];
                Matrix.RiskMatrixConfigID = Convert.ToInt32(row["RiskMatrixConfigID"]);
                Matrix.MatrixName = row["MatrixName"].ToString();
                Matrix.MatrixSize = Convert.ToInt32(row["MatrixSize"]);
                Matrix.IsDynamic = Convert.ToBoolean(row["IsDynamic"]);
                Matrix.ConfigJson = row["ConfigJson"].ToString();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Matrix load failed: {ex.Message}");
        }
    }

    private async Task LoadToleranceAsync()
    {
        try
        {
            var json = await Http.GetStringAsync("/api/S7SRisk/Tolerance");
            var table = JsonConvert.DeserializeObject<DataTable>(json);
            if (table != null && table.Rows.Count > 0)
            {
                var row = table.Rows[0];
                Tolerance.RiskToleranceID = Convert.ToInt32(row["RiskToleranceID"]);
                Tolerance.RiskMatrixConfigID = row["RiskMatrixConfigID"] == DBNull.Value ? null : Convert.ToInt32(row["RiskMatrixConfigID"]);
                Tolerance.HighThreshold = Convert.ToInt32(row["HighThreshold"]);
                Tolerance.MediumThreshold = Convert.ToInt32(row["MediumThreshold"]);
                Tolerance.LowLabel = row["LowLabel"].ToString();
                Tolerance.MediumLabel = row["MediumLabel"].ToString();
                Tolerance.HighLabel = row["HighLabel"].ToString();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Tolerance load failed: {ex.Message}");
        }
    }

    private async Task SaveMatrixAsync()
    {
        try
        {
            await Http.PostAsJsonAsync("/api/S7SRisk/SaveMatrixConfiguration", Matrix);
            await LoadAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Matrix save failed: {ex.Message}");
        }
    }

    private async Task SaveToleranceAsync()
    {
        try
        {
            await Http.PostAsJsonAsync("/api/S7SRisk/SaveTolerance", Tolerance);
            await LoadPreviewAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Tolerance save failed: {ex.Message}");
        }
    }

    private async Task LoadPreviewAsync()
    {
        try
        {
            var data = new[]
            {
                new { Impact = 1, Likelihood = 1, Count = 1 },
                new { Impact = Matrix.MatrixSize, Likelihood = Matrix.MatrixSize, Count = 1 }
            };
            await JS.InvokeVoidAsync("RiskHeatmap.render", "risk-matrix-preview", data, Matrix.MatrixSize, Tolerance.HighThreshold, Tolerance.MediumThreshold);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Matrix preview failed: {ex.Message}");
        }
    }
}
