@using Microsoft.AspNetCore.Components.Forms
@page "/login"
@using Microsoft.Extensions.Localization
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IStringLocalizerFactory LocalizerFactory

<h3>@Localizer["Sign In"]</h3>

<EditForm Model="loginModel" OnValidSubmit="DoLogin">
  <DataAnnotationsValidator />
  <div class="mb-3">
    <label class="form-label">@Localizer["Email"]</label>
    <InputText class="form-control" @bind-Value="loginModel.Email" />
  </div>
  <div class="mb-3">
    <label class="form-label">@Localizer["Password"]</label>
    <InputText class="form-control" type="password" @bind-Value="loginModel.Password" />
  </div>
  <button class="btn btn-primary">@Localizer["Login"]</button>
  @if(!string.IsNullOrEmpty(error))
  {
    <div class="text-danger mt-2">@error</div>
  }
</EditForm>

@code {
  private IStringLocalizer Localizer;
  private LoginModel loginModel = new();
  private string error;

  protected override void OnInitialized()
  {
    Localizer = LocalizerFactory.Create(new Uri(Navigation.Uri).AbsolutePath, "");
  }

  private class LoginModel
  {
    public string Email { get; set; }
    public string Password { get; set; }
  }

  private async Task DoLogin()
  {
    try
    {
      var res = await Http.PostAsJsonAsync("/api/CurrentUser/Login", loginModel);
      if (res.IsSuccessStatusCode)
      {
        Navigation.NavigateTo("/", true);
      }
      else
      {
        error = Localizer["Invalid credentials"].Value;
      }
    }
    catch(Exception ex)
    {
      error = ex.Message;
    }
  }
}

