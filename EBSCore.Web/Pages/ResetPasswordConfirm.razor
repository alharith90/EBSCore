@page "/reset-password/confirm"
@layout null
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.Extensions.Localization
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IStringLocalizerFactory LocalizerFactory

<div class="wrapper">
    <div class="section-authentication-cover">
        <div class="">
            <div class="row g-0">
                <div class="col-12 col-xl-7 col-xxl-8 auth-cover-left align-items-center justify-content-center d-none d-xl-flex">
                    <div class="card shadow-none bg-transparent shadow-none rounded-0 mb-0">
                        <div class="card-body">
                            <img src="assets/images/login-images/login-cover.svg" class="img-fluid auth-img-cover-login" width="650" alt="reset" />
                        </div>
                    </div>
                </div>
                <div class="col-12 col-xl-5 col-xxl-4 auth-cover-right align-items-center justify-content-center">
                    <div class="card rounded-0 m-3 shadow-none bg-transparent mb-0">
                        <div class="card-body p-sm-5">
                            <div class="text-center mb-4">
                                <h5>@Localizer["ResetPasswordConfirmTitle"]</h5>
                                <p class="mb-0">@Localizer["ResetPasswordConfirmSubtitle"]</p>
                            </div>
                            <div class="form-body">
                                <EditForm Model="confirmModel" OnValidSubmit="SubmitReset">
                                    <DataAnnotationsValidator />
                                    @if (!string.IsNullOrEmpty(alertMessage))
                                    {
                                        <div class="alert @alertClass" role="alert">@alertMessage</div>
                                    }
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <label class="form-label">@Localizer["NewPassword"]</label>
                                            <InputText class="form-control" type="password" @bind-Value="confirmModel.NewPassword" />
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">@Localizer["ConfirmPassword"]</label>
                                            <InputText class="form-control" type="password" @bind-Value="confirmModel.ConfirmNewPassword" />
                                        </div>
                                        <div class="col-12">
                                            <div class="d-grid">
                                                <button type="submit" class="btn btn-primary">@Localizer["ResetPassword"]</button>
                                            </div>
                                        </div>
                                    </div>
                                </EditForm>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private IStringLocalizer Localizer;
    private ResetPasswordConfirmRequest confirmModel = new();
    private string alertMessage;
    private string alertClass = "alert-success";

    protected override void OnInitialized()
    {
        Localizer = LocalizerFactory.Create(new Uri(Navigation.Uri).AbsolutePath, "");
        var query = new Uri(Navigation.Uri).Query;
        var parsed = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(query);
        if (parsed.TryGetValue("token", out var tokenValue))
        {
            confirmModel.Token = tokenValue;
        }
    }

    private async Task SubmitReset()
    {
        alertMessage = string.Empty;
        alertClass = "alert-success";
        try
        {
            var response = await Http.PostAsJsonAsync("/api/CurrentUser/ResetPasswordConfirm", confirmModel);
            if (response.IsSuccessStatusCode)
            {
                alertMessage = Localizer["PasswordResetSuccess"].Value;
            }
            else
            {
                alertClass = "alert-danger";
                alertMessage = Localizer["PasswordResetFailed"].Value;
            }
        }
        catch (Exception ex)
        {
            alertClass = "alert-danger";
            alertMessage = ex.Message;
        }
    }
}
